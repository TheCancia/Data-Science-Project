---
title: "Una Random Walk a MonteCarlo"
author: "Mauro"
date: "3/7/2021"
output:
  ioslides_presentation:
    widescreen : true
    smaller : true
    css: G:/uniud 2020/data science/progetto/Progetto Data Science/style.css
    incremental: yes
  html_document:
    df_print: paged

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, message = FALSE, warning = FALSE)
```

## Possiamo pensare di predirre il rendimento di un Titolo ? 

Se conoscessi il modo per predirre in modo consistente il rendimento di un titolo di certo non lo racconterei così tranquillamente XD.

tramite questa breve presentazione tenterò, tramite due modelli matematici, quali la Random Walk e La Camminata di Monte Carlo di predirre il futuro rendimento di un titolo Azionario quotato nell'indice S&P 500. 
Per confermare queste asserzioni andrò ad utilizzare il CAGR, un indicatore che rappresenta la crescita percentuale di un titolo. 


## Idea di base 

è il sogno di qualsiasi trader avere la possibilità di predirre il futuro, enventi come la bolla di internet, il tracollo finanziario del 2008 oppure l'attuale pandemia, hanno contribuito a cambiare completamente lo scenario della finanza moderna. 

Pensare di predirre questi eventi è fantascienza, ma possiamo studiare e applicare dei metodi sempre più interessanti per ottenere possibili
rendimenti futuri. Nella mia poca espreienza come Trader mi sono reso conto che nulla è così semplice (come sembra da fuori), la volatilità  
purtroppo non ci permette di definire delle predizioni così chiare; ma un'approccio di investimento chiamato Quantitative Trading si prefissa
di usare Modelli Matematici per provare a predirre Rendimenti e prezzi Futuri. 
Personalmente abbraccio questo movimento a braccia aperte, sia per una propensione Matematica, sia per la possibilità di implementare questi
modelli in Linguaggi di programmazione come R e Python. 
In questa breve presentazione andremo ad utilizzare 2 modelli molto interessanti che ci permettono sia di simulare l'andamento di un prezzo 
sia di eseguire questa simulazione N volte. 

## Quali sono questi Modelli ? 
 La spina dorsale di questa analisi si basa su 2 modelli e una teoria : 
 
   1) Il Secondo pilastro della filosofia di Trading di John Murphy, ovvero : " Il Mercato si Ripete".   
   2) La Random Walk -> la formalizzazione dell'idea di prendere passi successivi in direzioni casuali. 
   3) La Simulazione di Montecarlo -> Un metodo per Trarre stime attraverso le simulazioni, generando una serie di Numeri  
                                      che tra loro non sono correlati, e che seguono una distribuzione di probabilità.  

Specifichiamo le librerie. 

```{r}
library(quantmod)   # per ottenere i prezzi dei titoli
library(xts)        # xts ci permette di lavorare con delle serie temporali 
library(rvest)      # libreria essenziale per il web scraping con R 
library(tidyverse)  # il nostro amato tidy 
library(stringr)    # working with strings
library(forcats)    # working with factors
library(lubridate)  # working with dates in tibbles / data frames
```

## Come otteniamo i dati ? 

Mi ero prefissato l'obbiettivo di non utilizzare un dataset di default, bensì sfruttare la libreria rvest per ottenere tutte le informazioni 
rilevanti. 
Andrò a sfruttare la funzione getSymbols proveniente dalla libreria QuantMod, per chiarezza ho deciso di specificare un intervallo di tempo 
che ci permette di effettuare la nostra analisi in modo più accurato. 

```{r, echo = FALSE}
getSymbols("TSLA", from = "2021-01-01", to = "2021-07-02")
```
```{r, echo = FALSE}
TSLA %>% head()
```
La tabella contiene i dati essenziali di una qualsiasi analisi tecnica, ovvero il prezzo di apertura, chiusura, massimo, minimo, il volume e l'adjusted price.
Ricordiamo che la natura di questi dati è influenzata da moltissimi fattori (anche non strettamente economici, vedasi i tweet di Elon Musk, oppure la CoCa Cola e Ronaldo), quindi andiamo a considerare l'Adjusted, ovvero il valore di un titolo azionario omettendo gli Stock Split.

## Un'occhiata al Grafico 

Un'approccio diametralmente opposto rispetto al Quantitative Trading è il Trading con i Grafici, ovvero l'utilizzo di grafici
e indicatori tecnici per ottenere segnali di Buy/Sell. 
L'unico problema di questo approccio è che è estramente soggettivo, io posso vedere un Candle Stick Pattern (una "figura" che si forma nel grafico) su un grafico dove qualcun'altro non vede niente. 
Personalmente mi fido dei dati, ma è sbagliato eliminare completamente questo approccio, qua sotto illustro il grafico di
TSLA con qualche indicatore interessante, quale RSI, Volume, MACD e Bande di Boillinger.

```{r,echo = FALSE}
TSLA %>%
    chartSeries(TA='addBBands();
                    addBBands(draw="p");
                    addRSI();
                    addVo();
                    addMACD()', 
                subset='2021',
                theme="white"
                ) 
```
Una occhiata veloce a questo grafico ci potrebbe suggerire una situazione di acquisto interessante, dato che abbiamo una Moving Average favorevole con dei volumi contenuti ed un RSI che si mantiene nella Zona del Buy. 

Ma non mi fido dei grafici, quindi per controllare questa asserzione in primis vado a richiedere il Rendimento sotto scala 
Logaritmica, usiamo questa scala per ragioni prettamente strutturali, date dal fatto che assumiamo i prezzi come distribuiti
normalmente. 

```{r, echo = FALSE}
TSLA %>%
  Ad() %>%
  dailyReturn(type = 'log') %>%
  head()
```
Tramite questa funzione abbiamo ottenuto il rendimento sotto scala logaritmica per i primi giorni di gennaio di Tesla, 

## Iniziamo a Visualizzare qualche Valore interessante 
 
Questa parte è stato ispirato da rForTraders.com e dalle lezioni di statistica del semestre precedente.

Supponiamo i dati come Non-Correlati e equi-distribuiti, solo grazie ad possiamo teoricamente definire un modello che ci permetta di definire il possibile futuro comportamento di un titolo in un intervallo di confidenza. 
Ricordiamo che in statistica quando si stima un parametro è spesso insufficente individuare un singolo valore, quando eseguiamo una stima 
qualsiasi dobbiamo includere un intervallo di valori plausibili per il parametro che abbiamo stimato. 

Iniziamo a controllare se il rendimento viene distribuito normalmente
```{r, echo = FALSE}
TSLA_log_returns <- TSLA %>%
  Ad() %>%
  dailyReturn(type = "log")
# richiediamo il ritorno logaritmico 
TSLA_log_returns %>%
  ggplot(aes(x = TSLA_log_returns)) + 
  geom_histogram(bins = 100) + 
  geom_density() + 
  geom_rug(alpha = 0.5)
```
Purtroppo non abbiamo una chiara corrispondenza a livello grafico con la distribuzione normale, questo probabilmente è dovuto ad i movimentimolto incerti del mercato azionario attuale. 
Assieme a questa distribuzione andiamo a definire un'intervallo di Confidenza 
```{r,echo = FALSE}
probs <- c(.005, .025, .25, .5, .75, .975, .995) # definiamo gli intervalli 
dist_log_returns <- TSLA_log_returns %>%
  quantile(probs = probs, na.rm = TRUE) # chiediamo la rimozione dei nulli 
dist_log_returns
```
Buone notizie ! Abbiamo iniziato a definire un intervallo dove troviamo il nostro rendimento. 

Visto che il nostro studio si basa sulla scala logaritmica andiamo a richiedere il rendimento in media e la deviazione standard. 
```{r, echo = FALSE }
mean_log_returns <- mean(TSLA_log_returns, na.rm = TRUE)
sd_log_returns <- sd(TSLA_log_returns, na.rm = TRUE)
mean_log_returns
sd_log_returns
```
Otteniamo un rendimento in media negativo, brutte notizie... 
```{r}
mean_log_returns %>%
  exp()
```
Otteniamo un intero < 1 quindi abbiamo una tendenza che è riconducibile ad un rendimento negativo, per chiarire questo concetto sarebbe 
opportuno definire un grafico che compara un titolo con un rendimento in media positivo. 

##  RANDOM WALK 
Definiamo  la Random Walk come un "oggetto" matematico che definisce un percorso, esso viene definito come una successione di "passi" 
randomici definiti in uno spazio matematico (solitamente gli interi). 
L'esempio standard della Random Walk è : supponiamo di partire da 0, il passaggio da 0 a -1 e da 0 a +1 sarà equiprobabile. 

Troviamo una divertente differenza tra la teoria finanziara della Random Walk, una teoria finanziara che afferma che i prezzi dei titoli 
sono casuali e non influenzati dagli eventi passati ! 
Tra sostenitori e contrari di questa teoria ci sarà sempre una lotta interminabile, personalmente mi posiziono con i contrari (se no non sarei qui a provare a predirre il rendimento di titoli). 

Tracciamo un parallelismo tra il puro modello matematico e il tentativo di predirre il prezzo di un titolo azionario utilizzando il concetto 
di equiprobabilità e supponendo che i dati siano uniformemente distribuiti.
In questo caso andremo a calcolare il "nuovo" prezzo usando un rendimento casuale (ottenuto dalla distribuzione normale) moltiplicato per
il prezzo del giorno precedente. 

Ricordo che visto che stiamo effettuando delle simulazioni abbiamo la necessità di definire un seed, ovvero un intero utilizzato per
contraddistinguere questo parametro. 

```{r}
# definiamo i parametri 
N <- 1000
mu <- mean_log_returns
sigma <- sd_log_returns
day <- 1:N
price_init <- TSLA$TSLA.Adjusted[[nrow(TSLA$TSLA.Adjusted)]]
# come detto in precedenza andiamo ad usare la Adjusted per eliminare gli Split 
set.seed(386)
price <- c(price_init, rep(NA, N-1))
# tramite un ciclo for andiamo a calcolare i prezzi 
for(i in 2:N){
  price[i] <- price[i-1] * exp(rnorm(1, mu, sigma))
}
price_sim <- cbind(day,price) %>%
  as_tibble()
# andiamo a visualizzare questa simulazione 
price_sim %>%
  ggplot(aes(day,price)) + 
  geom_line() + 
  ggtitle(str_c("Andiamo a definire la simulazione dei prezzi di TSLA per", N, " Giorni di Trading"))

```
Questa simulazione è interessante anche perchè ci rendiamo conto che per 1000 giorni di trading andremo a perdere molti soldi
Ma possiamo fidarci di questa simulazione ? NO! 
Questa è solamente UNA delle possibili proiezioni relative al titolo TSLA, ricordiamo che tramite il seed abbiamo la possibilità di effettuare una differente simulazione semplicemente variando il valore,il passo successivo è eseguire N iterazioni della Random Walk.

## Come definiamo la Simulazione di Monte Carlo ? 

La simulazione di Montecarlo è una stima quantitativa dei rischi, queste stime si prefiggono l'obbiettivo di stimare la distribuzione delle
variabili casuali aleatorie rappresentative dei rischi finanziari, questa simulazione proviene da solide basi matematiche che ci permettono 
di cercare la soluzioni di un problema, rappresentandolo e stimandolo tramite l'esame di un campione estratto dalla popolazione, mediante
una sequenza di numeri casuali. 
Questa propietà ci permette di concatenare queste due teorie (Random Walk e Monte Carlo), dato che tramite la Random Walk definiamo una 
serie di valori randomici; in modo più pratico abbiamo la possibilità di stimare la variabile aletatoria obbiettiva (il rendimento) andando
a generare un numero sufficentemente elevato di Scenari (iterazioni) casuali con i quali costruire la distribuzione di frequenza. 
In questo caso andremo ad eseguire 300 giorni e 300 simulaizoni. 

```{r}
# definiamo i parametri 
N <- 300
M <- 300  
mu <- mean_log_returns
sigma <- sd_log_returns
day <- 1:N 
price_init <- TSLA$TSLA.Adjusted[[nrow(TSLA$TSLA.Adjusted)]]
# andiamo a simulare i prezzi 
set.seed(123)
monte_carlo_mat <- matrix(nrow = N, ncol = M)
for(j in 1:M){
  monte_carlo_mat[[1,j]] <- price_init
  for(i in 2:N){
    monte_carlo_mat[[i,j]] <- monte_carlo_mat[[i-1,j]] * exp(rnorm(1, mu, sigma))
  }
}
# avendo creato un dataframe è necessario organizzarlo in modo "chiaro" 
price_sim <- cbind(day, monte_carlo_mat) %>%
  as_tibble()
nm <- str_c("Sim", seq(1,N))
nm <- c("Day", nm)
names(price_sim) <- nm 
price_sim <- price_sim %>%
  gather(key = "Simulation", value = "Stock.Price", -(Day))
# visualizziamo la simulazione 
price_sim %>%
    ggplot(aes(x = Day, y = Stock.Price, Group = Simulation)) + 
    geom_line(alpha = 0.1) +
    ggtitle(str_c("TSLA: ", M, 
                  " Simulazione di Monte Carlo per  ", N, 
                  " Giorni di Trading "))

```
Come in precedenza andiamo a richiedere l'intervallo di confidenza dei prezzi alla fine della simulazione 
```{r, echo = FALSE}
end_stock_prices <- price_sim %>%
  filter(Day == max(Day))
probs <- c(.005, .025, .25, .5, .75, .975, .995)
dist_end_stock_prices <- quantile(end_stock_prices$Stock.Price, probs = probs)
dist_end_stock_prices  %>%
  round(2)
```
Purtroppo abbiamo una distribuzione di dati (e qundi di rendimenti) molto ampi, ma  il nostro grafico presenta degli ovvi outliner, anche se 
possiamo notare tra 100 a 1500 abbiamo una grande concentrazione di predizioni. 
Eseguite queste due simulazioni dobbiamo chiederci se tutto questo ha senso, abbiamo la possibilità di farlo tramite il C.A.G.R 

## Ma possiamo realmente fidarci di questa simulazione ? 
Il Tasso Composto di Crescita Annuo o CAGR (per usare acronimi anglosassoni), rappresenta la crescita percentuale media di una grandezza in un lasso di tempo; solitamente questo tasso viene usato per determinare il fatturato di una Azione all'anno, fornendoci la crescita percentuale.
Per chiarezza definiamo il Tasso di Crescita -> il rapporto fra crescita e Valore iniziale --> $[X1-X0]/X0$ Dove X1 e X0 sono due istanti temporali differenti, Se consideriamo più istanti temporali dobbiamo ricalcolare la crescita sul periodo precedente. 
La prima epoca sarà -> $X1 = X0[c+1]*2$; la seconda sarà -> $X2 = X1[c+1]$
Questa struttura sarà ripetuta per un N iterazioni dando per scontato un tasso di Crescita costante. 

Noi utilizzeremo il CAGR come un'indicatore per calcolare il rendimento medio di un investimento in un dato periodo, ottenendo una performance media annuale. 

```{r, echo = FALSE}
# definiamo i nostri input 
N_hist <- nrow(TSLA) / 252 
p_start_hist <- TSLA$TSLA.Adjusted[[1]]
p_end_hist <- TSLA$TSLA.Adjusted[[nrow(TSLA)]]
N_sim <- N / 252
p_start_sim <- p_end_hist
p_end_sim <- dist_end_stock_prices[[4]]
#introduciamo il CAGR (i valori sono stati ottenuti dal loro summary)
CAGR_historical <- (p_end_hist / p_start_hist) ^ (1 / N_hist) - 1
CAGR_sim        <- (p_end_sim / p_start_sim) ^ (1 / N_sim) - 1
CAGR_historical
```

```{r}
CAGR_sim
```
```{r}
diff <- CAGR_historical - CAGR_sim
diff
```

In Conclusione io mi ritengo soddisfatto, abbiamo ottenuto una differenza di $-0.04213$ tra il CAGR e la simulazione, ci siamo avvicinati ai rendimenti in media teorici. 
Purtroppo però c'è da dire che questo indicatore ci fornisce una performance media che anno per anno potrà essere stata anche molto distante 
dal valore ottenuto, e di conseguenza bisgona ricordare che il rendimento di un investimento si è attestato su un valore del passato non 
vè alcuna garanzia che in futuro si ottenga lo stesso. 

Bibliografia : 

   - Mary Buffett, David Clark The New Buffettology 
   - Philip A. Fisher Common Stocks and Uncommon Profits and Other Writings Wiley Investment Classics
   - Cathy O’Neil Weapons of Math Destruction How Big Data Increases Inequality and Threatens Democrac 
   - http://www.traderpedia.it/
   - https://en.wikipedia.org/wiki/Random_walk
   - https://wowscienza.it/cose-la-simulazione-montecarlo/
   - Corso di Statistica 
   - Marcos Lòpez de Prado Advances in Financial Machine Learning 
